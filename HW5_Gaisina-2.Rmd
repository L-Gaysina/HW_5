---
title: "Untitled"
author: "Gaisina Liana"
date: "2024-04-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Homework № 5. Построение регрессионных моделей и анализ выживаемости

```{r}
# Загрузка необходимых библиотек
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
```

## Задание 1 (2 балла)

> Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
>
> Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
data <- read.csv("wisconsin_breast_cancer.csv")

head(data)
str(data)
```

```{r}
# Регрессионная модель для средней площади
model_area <- lm(area_mean ~ radius_mean, data=data)
summary(model_area)

# Построение графика
ggplot(data, aes(x=radius_mean, y=area_mean)) +
  geom_point(color="skyblue") +
  geom_smooth(method="lm", color="red") +
  ggtitle("Зпвисимость среднего радиуса от средней площади") +
  xlab("Средний радиус") +
  ylab("Средняя площадь")
```

### Вывод:

Из графика и статистических данных регрессионного анализа видно, что существует сильная положительная корреляция между средним радиусом и средней площадью опухоли. Уравнение регрессии, со значительным коэффициентом при радиусе (98.5982), указывает на то, что с увеличением среднего радиуса на одну единицу, средняя площадь увеличивается в среднем на 98.6 единиц. Значения p-value для обоих коэффициентов (перехват и наклон) фактически равны нулю, что подтверждает статистическую значимость этих коэффициентов.

Кроме того, высокое значение R-квадрата (0.9749) свидетельствует о том, что модель очень хорошо объясняет вариабельность средней площади на основе среднего радиуса. Стандартная ошибка остатков (55.83) и диапазон остатков также подсказывают о точности модели, но наличие относительно большого максимального остатка (535.47) может указывать на наличие выбросов или нелинейности в данных, что может потребовать дополнительного анализа или применения более сложных моделей.

```{r}
# Регрессионная модель для среднего периметра
model_perimeter <- lm(perimeter_mean ~ radius_mean, data=data)
summary(model_perimeter)

# Построение графика
ggplot(data, aes(x=radius_mean, y=perimeter_mean)) +
  geom_point(color="skyblue") +
  geom_smooth(method="lm", color="red") +
  ggtitle("Зависимость среднего радиуса от среднего периметра") +
  xlab("Средний радиус") +
  ylab("Средний периметр")

```

### Вывод:

Этот график показывает сильную положительную корреляцию между средним радиусом и средним периметром опухоли. Коэффициент наклона равен 6.8804, что означает, что на каждую единицу увеличения среднего радиуса, средний периметр увеличивается на примерно 6.88 единиц.

Судя по значению p-value, которое практически равно нулю как для перехвата, так и для коэффициента радиуса, можно сказать, что оба параметра статистически значимы. Величина t-статистики для **`radius_mean`** указывает на очень сильное влияние этой переменной на **`perimeter_mean`**.

Коэффициент детерминации R² равен 0.9957, что свидетельствует о том, что почти вся вариативность среднего периметра может быть объяснена изменениями среднего радиуса в этой линейной модели. Стандартная ошибка остатков в 1.592 является относительно малой, что подтверждает высокую точность модели.

Минимальные и максимальные остатки (-4.0708 и 10.0859 соответственно) указывают на то, что большинство значений соответствует предсказаниям модели, хотя наличие некоторых больших остатков может указывать на потенциальные выбросы или нелинейность, которые стоит рассмотреть более внимательно.

```{r}
# Регрессионная модель для средней симметричности
model_symmetry <- lm(symmetry_mean ~ radius_mean, data=data)
summary(model_symmetry)

# Построение графика
ggplot(data, aes(x=radius_mean, y=symmetry_mean)) +
  geom_point(color="skyblue") +
  geom_smooth(method="lm", color="red") +
  ggtitle("Зависимость среднего радиуса от средней симметричности") +
  xlab("Средний радиус") +
  ylab("Средняя симметричность")

```

### Вывод:

Связь между средним радиусом и средней симметричностью опухоли намного слабее, чем в предыдущих двух случаях. Коэффициент детерминации (R²) равен всего 0.02183, что говорит о том, что только около 2.2% вариабельности средней симметричности может быть объяснено изменениями в среднем радиусе.

Коэффициент наклона регрессионной линии составляет 0.0011493, что указывает на очень незначительное увеличение средней симметричности с ростом среднего радиуса. Однако этот коэффициент статистически значим, как показывает p-value (0.000406), что говорит о том, что хотя связь и слаба, она всё же существует.

Стандартная ошибка остатков составляет 0.02714, что довольно мало, но, учитывая малую силу связи, величина этой ошибки не столь критична. Распределение остатков кажется симметричным, с минимальными и максимальными значениями (-0.07180 и 0.11938 соответственно), что указывает на отсутствие больших выбросов или сильной асимметрии остатков.

В целом, данные показывают, что существует слабая, но статистически значимая положительная корреляция между средним радиусом и средней симметричностью опухоли.

## Задание 2 (2 балла)

> Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).
>
> Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
# Преобразуем диагноз в числовой формат
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)  
str(data)
```

```{r}
# Логистическая регрессионная модель
model_radius <- glm(diagnosis ~ radius_mean, data=data, family=binomial)

# Визуализация
ggplot(data, aes(x=radius_mean, y=diagnosis)) +
  geom_jitter(width=0.1, height=0.02, alpha=0.5,color="skyblue") +
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE, color="red") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от среднего радиуса") +
  xlab("Средний радиус") +
  ylab("Вероятность злокачественной опухоли")

```

### **Вывод:**

Коэффициент наклона равен 1.03359, что указывает на сильное влияние среднего радиуса на вероятность злокачественной опухоли. Статистическая значимость этого коэффициента подтверждается очень низким p-value (\<2e-16), что указывает на надёжность этой оценки.

Средний радиус является мощным предиктором злокачественности опухоли, при этом вероятность злокачественной опухоли значительно возрастает с увеличением среднего радиуса опухоли.

```{r}
# Логистическая регрессионная модель
model_area <- glm(diagnosis ~ area_mean, data=data, family=binomial)
summary(model_area)

# Визуализация
ggplot(data, aes(x=area_mean, y=diagnosis)) +
  geom_jitter(width=0.1, height=0.02, alpha=0.5, color="skyblue") +
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE, color="red") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от средней площади") +
  xlab("Средний радиус") +
  ylab("Вероятность злокачественной опухоли")

```

### **Вывод:**

Из графика и результатов модели видно, что по мере увеличения площади опухоли, значительно повышается вероятность того, что опухоль окажется злокачественной. Этот эффект статистически подтверждён значимостью коэффициента площади и его p-value, которое практически равно нулю. Модель достигла хорошей степени точности, что видно по низкому значению AIC и значительному уменьшению остаточного девианса по сравнению с нулевой моделью. Это говорит о том, что размер опухоли может быть важным индикатором её злокачественности.

```{r}
# Логистическая регрессионная модель
model_texture <- glm(diagnosis ~ texture_mean, data=data, family=binomial)
summary(model_texture)

# Визуализация
ggplot(data, aes(x=texture_mean, y=diagnosis)) +
  geom_jitter(width=0.1, height=0.02, alpha=0.5, color="skyblue") +
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE, color="red") +
  ggtitle("Вероятность злокачественной опухоли в зависимости от cредней площади") +
  xlab("Средний радиус") +
  ylab("Вероятность злокачественной опухоли")
```

### **Вывод:**

По графику и результатам статистического анализа видно, что текстура опухоли тоже влияет на вероятность того, что опухоль окажется злокачественной. Коэффициент для переменной **`texture_mean`** положителен и статистически значим, что означает, что с более шероховатой или неровной текстурой опухоли растёт вероятность её злокачественного характера.

```{r}
# Комплексная логистическая регрессионная модель
model_complex <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data=data, family=binomial)
summary(model_complex)


```

-   **radius_mean**: Коэффициент для среднего радиуса составляет -0.38523. Это значение не является статистически значимым (p = 0.687), что означает, что изменения в среднем радиусе не оказывают значимого влияния на вероятность злокачественности опухоли.

-   **area_mean**: Коэффициент для средней площади составляет 0.01636. Этот коэффициент также не достигает статистической значимости (p = 0.137).

-   **texture_mean**: Коэффициент для текстуры составляет 0.20917, который является единственным статистически значимым коэффициентом (p \< 0.001). Это указывает на то, что с увеличением средней текстуры вероятность злокачественного диагноза увеличивается

    ### **Вывод**

    Модель показывает, что из трех рассмотренных предикторов только средняя текстура (**`texture_mean`**) имеет статистически значимое влияние на вероятность злокачественности опухоли, указывая на положительную связь. Остальные предикторы (**`radius_mean`** и **`area_mean`**) не показали статистической значимости в данной модели. Это подчеркивает важность средней текстуры как фактора, влияющего на диагноз, при условии, что другие переменные остаются постоянными. Однако отсутствие значимости у других коэффициентов не означает, что они не важны в другом контексте или при включении в модель других переменных.

## Задание 3 (6 балла)

> Для выполнения этого задания вам понадобится датасет `lung`, который встроен в пакет `survival`. Установите этот пакет и загрузите датасет.

```{r}
# Загрузка данных
lung <- survival::lung
head(lung)
```

> Датасет содержит следующий набор переменных:
>
> -   `inst`: код учреждения;
>
> -   `time`: время выживаемости в днях;
>
> -   `status`: 1 = цензурирование, 2 = смерть;
>
> -   `age`: возраст в годах;
>
> -   `sex`: мужской = 1, женский = 2;
>
> -   `ph.ecog`: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
>
> -   `ph.karno`: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
>
> -   `pat.karno`: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
>
> -   `meal.cal`: калории потребляемой пищи;
>
> -   `wt.loss`: потеря веса за последние полгода.
>
> Создайте переменную `event`, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

```{r}
# Cоздание переменной event
lung$event <- ifelse(lung$status == 2, 1, 0)  # Смерть считается событием (1)
str(lung)
```

> Изучите работу функций `Surv()`, `survfit()` и `ggsurvplot()`:
>
> -   Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
>
> -   Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
>
> -   С помощью функции `coxph()` постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# Выборка пациентов с летальным исходом
lung_2 <- filter(lung,lung$event == 1)
head(lung_2)

# Создание объекта Surv
surv_object <- Surv(time = lung_2$time, event = lung_2$event)

# Построение модели выживаемости в зависимости от пола
fit_sex <- survfit(surv_object ~ lung_2$sex, data = lung_2)

# Визуализация кривых выживаемости с помощью ggsurvplot
ggsurvplot(fit_sex, data = lung_2, pval = TRUE, risk.table = TRUE)


```

```{r}
# Лог-ранговый тест для сравнения кривых выживаемости
survdiff(Surv(time, status) ~ sex, data = lung_2)

```

### **Интерпретация:**

Поскольку p-value равно 0.1, это означает, что нет статистически значимого различия в выживаемости между мужчинами и женщинами в данной выборке на уровне значимости 0.05.

```{r}
#Кумулятивная функция рисков по полу
ggsurvplot(fit_sex, data = lung_2, fun = "cumhaz", pval = TRUE, risk.table = TRUE)

```

1.  **Кумулятивные риски увеличиваются со временем для обеих групп.** Это ожидаемо, так как чем дольше пациенты находятся в исследовании, тем выше вероятность наступления события.

2.  **Кривые показывают некоторое различие в риске между полами.** Однако, судя по значению p (p=0.13), это различие не является статистически значимым. Это значит, что на уровне значимости 0.05 мы не можем утверждать, что риски смерти между мужчинами и женщинами различаются.

3.  **Количество людей, подверженных риску (number at risk),** уменьшается со временем, что отражает количество оставшихся в исследовании пациентов, которые ещё не испытали событие (смерть) или не были цензурированы (исключены из исследования по каким-либо причинам).

### Вывод:

График демонстрирует, что риск смерти постепенно увеличивается для всех пациентов, но различия между мужчинами и женщинами не настолько велики, чтобы говорить о статистически подтвержденной зависимости выживаемости от пола.

```{r}
# Регрессия Кокса
cox_model <- coxph(Surv(time, event) ~ sex, data = lung_2)
summary(cox_model)
```

-   **coef (коэффициент)**: Значение **`-0.2511`** указывает на направление и величину влияния пола на риск смерти. Отрицательный коэффициент говорит о том, что существует тенденция к снижению риска смерти у женщин по сравнению с мужчинами, так как в данной модели мужской пол кодируется как **`sex=1`**, а женский как **`sex=2`**.

-   **exp(coef) (экспоненцированный коэффициент)**: Значение **`0.7779`** является отношением рисков (hazard ratio), которое говорит нам о том, что риск смерти для женщин на 22.21% ниже, чем для мужчин.

-   **Pr(\>\|z\|) (p-value)**: Значение **`0.136`** говорит о том, что нет статистически значимого доказательства того, что пол влияет на риск смерти в этом датасете (при уровне значимости 0.05).

-   **lower .95 и upper .95**: 95% доверительный интервал для отношения рисков (0.5594 - 1.082) включает 1, что также указывает на отсутствие статистически значимого влияния пола на риск смерти.

-   **Concordance**: Значение **`0.543`** говорит о том, что предсказательная способность модели лучше случайного угадывания, но не значительно.

-   **Тесты сравнения модели с нулевой моделью**: Значения p-value для всех трёх тестов (Likelihood ratio test, Wald test, Score (logrank) test) около **`0.1`** свидетельствуют о том, что добавление пола как фактора в модель не приводит к значительному улучшению модели по сравнению с моделью без пола.

**Вывод:** Пол не оказывает статистически значимого влияния на выживаемость пациентов в данном анализе. Однако отношение рисков ниже единицы может предполагать клинически значимую тенденцию к меньшему риску смерти у женщин, хотя для окончательных выводов могут потребоваться дополнительные исследования с большими выборками или более детальный анализ с учетом других факторов.
